<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.80.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel='stylesheet' id='oswald-css'  href='//fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all'>
  <link rel="stylesheet" href="https://ixday.github.io/css/style.css" type='text/css' media='all'>
  <link rel="stylesheet" href="https://ixday.github.io/css/pygment.css" type='text/css' media='all'>
  
  <title>Not today... - Start libvirt VM as unprivileged user</title>
  <meta property='og:title' content="Start libvirt VM as unprivileged user - Not today...">
  <meta property="og:type" content="article">
  

</head>

  <body>
    <div class="container">
    <header>
  <h1 id="site-title"><a href="https://ixday.github.io/">Not today...</a></h1>
  <nav id="menu">
    <ul>
      
        
          <li><a href="https://github.com/IxDay">github</a></li>
        
      
      
      
      <li><a href="/categories/os">os</a></li>
      
      <li><a href="/categories/project">project</a></li>
      
      <li><a href="/categories/snippet">snippet</a></li>
      
      <li><a href="/categories/tuto">tuto</a></li>
      
      
    </ul>
  </nav>
</header>

    
    <div class="contents">
      
<article>
  <div class="meta">
  <time class="date">
    
    Mon May 1 2017
    
  </time>
  <div class="comments">
    <a href="https://ixday.github.io/post/unprivileged_libvirt/#disqus_thread">
      <span class="disqus-comment-count" data-disqus-identifier="IxDay">
      </span>
      comments
    </a>
  </div>
  <p class="categories">
  
  <a href="/categories/os">os</a>
  
  </p>
</div>

  <div class="caption">
    <header>
      <h2>Start libvirt VM as unprivileged user</h2>

      
      <p class="tags">
      <strong>Tagged</strong>
      <a href="/tags/admin ">admin</a>
, <a href="/tags/bash ">bash</a>

      </p>
      

    </header>
    <p>Quick post for starting a VM inside libvirt as a non-root user. Also contains
some useful snippets.</p>
<p>I want to start an alpine virt iso (<a href="https://alpinelinux.org/downloads/">from here</a>)
inside kvm through <code>libvirt</code>. But I am sick to run all my virsh commands prefixed with sudo.</p>
<p><strong>DISCLAIMER</strong>: This will contain some of my conclusions with my partial understanding
of those tools. I am quite sure that all of this can be improved, but I don&rsquo;t
have time to invest on this for the moment.</p>
<h2 id="packages-and-doc">Packages and doc</h2>
<p>To do this I have to install all the libvirt stuff and dependencies. I recently
changed my distrib for an Archlinux, relevant articles can be found here:</p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/KVM">KVM</a></li>
<li><a href="https://wiki.archlinux.org/index.php/QEMU">QEMU</a></li>
<li><a href="https://wiki.archlinux.org/index.php/libvirt">libvirt</a></li>
</ul>
<p>Installed packages are:</p>
<ul>
<li><code>libvirt</code></li>
<li><code>qemu</code></li>
<li><code>virt-install</code></li>
</ul>
<p>Libvirt is a wrapper around virtualization solutions, you can use it to
start containers and VMs through different tools and hypervisors. The <code>virt-install</code>
package is just a plugin of <code>libvirt</code> to manage VMs installations. You can
perform all those operations directly through <code>QEMU</code> if you want.</p>
<h2 id="setup">Setup</h2>
<p><em>Note: libvirt command line interface is <code>virsh</code>, because fuck logic, so
you don&rsquo;t get lost in the following.</em></p>
<p>To make all this work I had to add myself to those groups: <code>kvm</code>, <code>libvirt</code>.</p>
<p>Libvirt comes with a definition of a default network, you can see it by typing:
<code>sudo virsh net-dumpxml default</code>. This will create and start a virtual bridge
named <code>virbr0</code>, for my case (check the name it will be important later on), when
the network is started.</p>
<p>What we will do is reuse this bridge for the VMs we will start in our user space.
To perform that we have to ensure that this network is started by libvirt at
startup:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># start libvirt at computer startup</span>
sudo systemctl <span class="nb">enable</span> libvirtd
<span class="c1"># ensure network is started by default</span>
sudo virsh net-autostart default
</code></pre></div><p>Now, just one last config, QEMU provides some ACL which will allow users to
interact with parts of it, we will modificate it to add access to the virtual
bridge. We also have to set suid on the qemu bridge command so a simple user
can get permissions for setting up bridge configuration.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># create ACL directory and set the value</span>
sudo mkdir -p /etc/qemu <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;allow virbr0&#34;</span> <span class="p">|</span> sudo tee /etc/qemu/bridge.conf
<span class="c1"># enable suid on qemu bridge tool</span>
locate qemu-bridge-helper <span class="p">|</span> sudo xargs chmod +s
</code></pre></div><p><strong>BEWARE:</strong> The default network bridge name has been used here (<code>virbr0</code>),
check if it is the one from your default network.</p>
<h2 id="shoot">Shoot!</h2>
<p>We just have to start our new VM now, be sure to have correctly logged out and
in again before running the following commands (it makes the group changes effective).</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># download the ISO</span>
wget https://nl.alpinelinux.org/alpine/v3.5/releases/x86_64/alpine-virt-3.5.2-x86_64.iso
<span class="c1"># start it</span>
virt-install			<span class="c1"># create a new VM through libvirt \</span>
	--virt-type kvm		<span class="c1"># use the kvm hypervisor \</span>
	--name alpine		<span class="c1"># VM name  \</span>
	--memory 1024		<span class="c1"># allocate 1024MB of RAM \</span>
	--disk <span class="nv">size</span><span class="o">=</span>10		<span class="c1"># allocate a volume of 10G for disk storage of the VM \</span>
	--noautoconsole		<span class="c1"># I don&#39;t want to start a gui on top of my VM (this part has to be investigated) \</span>
	--cdrom alpine-virt-3.5.2-x86_64.iso	<span class="c1"># the disk iso for the installation \</span>
	--network <span class="nv">bridge</span><span class="o">=</span>virbr0,model<span class="o">=</span>virtio	<span class="c1"># the tricky part now, I define the bridge to attach my VM to \</span>
						<span class="c1"># the model=virtio is something which makes it work properly, \</span>
						<span class="c1"># also have to investigate it</span>

virsh console --domain alpine <span class="c1"># attach our console to the VM console</span>
</code></pre></div><p>You should have a running VM and be able to control it without any <code>sudo</code> command.
Yay \o/</p>
<h2 id="some-snippets">Some snippets</h2>
<p>I use some shell snippets to control the destruction of my VM.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">vm</span><span class="o">=</span>alpine
<span class="c1"># stop a dedicated vm</span>
virsh list <span class="p">|</span> awk <span class="s1">&#39;$2 ~ /&#39;</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">vm</span><span class="si">}</span><span class="s2">&#34;</span><span class="s1">&#39;/ {system(&#34;virsh destroy &#34; $2)}&#39;</span>
<span class="c1"># delete it</span>
virsh list --all <span class="p">|</span> awk <span class="s1">&#39;$2 ~ /&#39;</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">vm</span><span class="si">}</span><span class="s2">&#34;</span><span class="s1">&#39;/ {system(&#34;virsh undefine &#34; $2)}&#39;</span>
<span class="c1"># delete all the volumes</span>
virsh vol-list default <span class="p">|</span> awk <span class="s1">&#39;NR &gt; 2 &amp;&amp; NF &gt; 0 {system(&#34;xargs virsh vol-delete --pool default &#34; $1)}&#39;</span>
</code></pre></div>
  </div>
</article>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "IxDay" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
    

    <footer id="footer">
	<p>&copy; 2021 IxDay</p>
	<p>Done with love... and beer</p>
  <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>,</p>
</footer>

    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-38228870-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>
