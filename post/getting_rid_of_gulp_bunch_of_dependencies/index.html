<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.29" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel='stylesheet' id='oswald-css'  href='//fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all'>
  <link rel="stylesheet" href="http://ixday.github.io/css/style.css" type='text/css' media='all'>
  <link rel="stylesheet" href="http://ixday.github.io/css/pygment.css" type='text/css' media='all'>
  
  <title>Not today... - Getting rid of gulp bunch of dependencies</title>
  <meta property='og:title' content="Getting rid of gulp bunch of dependencies - Not today...">
  <meta property="og:type" content="article">
  

</head>

  <body>
    <div class="container">
    <header>
  <h1 id="site-title"><a href="http://ixday.github.io/">Not today...</a></h1>
  <nav id="menu">
    <ul>
      
        
          <li><a href="https://github.com/IxDay">github</a></li>
        
      
      
      
      <li><a href="/categories/os">os</a></li>
      
      <li><a href="/categories/project">project</a></li>
      
      <li><a href="/categories/snippet">snippet</a></li>
      
      <li><a href="/categories/tuto">tuto</a></li>
      
      
    </ul>
  </nav>
</header>

    
    <div class="contents">
      
<article>
  <div class="meta">
  <time class="date">
    
    Sun Apr 10 2016
    
  </time>
  <div class="comments">
    <a href="http://ixday.github.io/post/getting_rid_of_gulp_bunch_of_dependencies/#disqus_thread">
      <span class="disqus-comment-count" data-disqus-identifier="IxDay">
      </span>
      comments
    </a>
  </div>
  <p class="categories">
  
  <a href="/categories/snippet">Snippet</a>
  
  </p>
</div>

  <div class="caption">
    <header>
      <h2>Getting rid of gulp bunch of dependencies</h2>

      
      <p class="tags">
      <strong>Tagged</strong>
      <a href="/tags/dev ">dev</a>
, <a href="/tags/javascript ">javascript</a>

      </p>
      

    </header>
    

<p>Recently Nodejs environment broke due the removal from npm
of a small library (11 SLOC): <code>leftpad</code>. As it hit the world
and broke a bunch of projects and CIs, I asked myself if my projects
contains so much dependencies that if one break, everything collapse.</p>

<h2 id="the-problem">The problem</h2>

<p>For developing my frontend I use a tool which I really like:
<a href="http://gulpjs.com/">Gulp</a>. The issue there, is that for working
with multiple building process involved a lot of glue and third
party libraries. Here is an example: <a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/browserify-uglify-sourcemap.md">https://github.com/gulpjs/gulp/blob/master/docs/recipes/browserify-uglify-sourcemap.md</a>
Just for using <a href="http://browserify.org/">browserify</a>
(which is another great tool). Each of those libraries involved other
dependencies and so on until we download the whole internet to perform the
most simple tasks.</p>

<h2 id="the-solution">The solution ?</h2>

<p>According to this, I started looking at those libraries in order to see
if I can implement them with a reduced number of dependencies and
lines of code. The answer is: yes, and moreover it is quite simple and
helps me learned some new things.</p>

<p>Here is the goal of the exercise:</p>

<ul>
<li>rewrite <code>vinyl-source-stream</code>, <code>merge-stream</code> and <code>vinyl-buffer</code></li>
<li>fix browserify in the gulp environment, according to
<a href="http://stackoverflow.com/questions/30077567/browserify-errors-ending-gulp-watch-task">this issue</a></li>
</ul>

<h2 id="the-implementation">The implementation</h2>

<p>To perform the implementation I will only keep the
<a href="https://github.com/rvagg/through2">through2 module</a> for better creating
streams (don&rsquo;t worry as it is a requirements of all the gulp plugins it will
not add a new dependency)
and <a href="https://github.com/gulpjs/gulp-util">gulp util</a> which will allow me
to have some helpers to deal with gulp (as through2 it will not create new
dependencies as it is a requirements for basically all the gulp plugins).</p>

<p>I will create a simple <code>utils.js</code> file aside my <code>gulpfile.js</code> to store
those implementations.</p>

<p>Here is the requirementents of the file:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">through</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">require</span><span class="s1388">(</span><span class="sc1c">&#39;through2&#39;</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">gutil</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">require</span><span class="s1388">(</span><span class="sc1c">&#39;gulp-util&#39;</span><span class="s1388">);</span></code></pre>
</div>
<h3 id="vinyl-source-stream">vinyl-source-stream</h3>

<p>According to its presentation this module only provide a convenient wrapper
in order to link legacy nodejs streams and gulp implementation of streams
vinyl.</p>

<p>Here is the code I use:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s7df">module</span><span class="s1388">.</span><span class="s7df">exports</span><span class="s1388">.</span><span class="s7df">source</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">filename</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// this is basically a stream, I will use the javascript scoping for
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// convenience
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">ins</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">through</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// here is the piping to the previous stream, we need an object stream as we
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// will push a vinyl file in it.
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// The use will be the following:
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// someLegacyStream.pipe(utils.source()).pipe(whateverInGulpWorld);
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">through</span><span class="s1388">.</span><span class="s7df">obj</span><span class="s1388">(</span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">chunk</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">_</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">cb</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// Checks if we have initialized the stream with a vinyl file
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s1770">// basically, this just happen once at startup of streaming.
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s1388">(</span><span class="sfa0">!</span><span class="s3e8">this</span><span class="s1388">.</span><span class="s7df">_ins</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s3e8">this</span><span class="s1388">.</span><span class="s7df">_ins</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">ins</span><span class="s1388">;</span><span class="s1f40"> </span><span class="s1770">// this is just a convenient way of keeping a state
</span><span class="s1770"></span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1770">// Create a vinyl file and pass &#34;ins&#34; stream as a content,
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s1770">// and an optional filename
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s3e8">this</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s3e8">new</span><span class="s1f40"> </span><span class="s7df">gutil</span><span class="s1388">.</span><span class="s7df">File</span><span class="s1388">({</span><span class="s7df">contents</span><span class="sfa0">:</span><span class="s1f40"> </span><span class="s7df">ins</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">path</span><span class="sfa0">:</span><span class="s1f40"> </span><span class="s7df">filename</span><span class="s1388">}));</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1388">}</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// push the chunk into our new stream in order to unify output
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">ins</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">chunk</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// as this is asynchronous just notify the system that we handled
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s1770">// the chunk
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">cb</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">},</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">()</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// close the stream by pushing &#34;null&#34;
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">ins</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s3e8">null</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s3e8">this</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s3e8">null</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1388">};</span></code></pre>
</div>
<p>Okay, so, we replace a whole module by ~14 SLOC, additionally I get back some
understanding on how nodejs streams work, and on gulp plugins implementation.</p>

<p>This is a good start! Let&rsquo;s continue this way</p>

<h3 id="merge-streams">merge-streams</h3>

<p>This module simply merge multiple streams in a single one, this allow the
developper to compose with multiple inputs.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s1f40"></span><span class="s1770">// the function treats arguments as a list of streams
</span><span class="s1770"></span><span class="s7df">module</span><span class="s1388">.</span><span class="s7df">exports</span><span class="s1388">.</span><span class="s7df">merge</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s1770">/* streams... */</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">sources</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s1388">[];</span><span class="s1f40"> </span><span class="s1770">// keep a track of streams merged
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">output</span><span class="s1f40">  </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">gutil</span><span class="s1388">.</span><span class="s7df">noop</span><span class="s1388">();</span><span class="s1f40"> </span><span class="s1770">// this will be the output,
</span><span class="s1770"></span><span class="s1f40">                              </span><span class="s1770">// a simple stream which does nothing
</span><span class="s1770"></span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// this function will be called when unpiping and when a source stream ends
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">function</span><span class="s1f40"> </span><span class="s7df">remove</span><span class="s1388">(</span><span class="s7df">source</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// remove the stream from sources array
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">sources</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">sources</span><span class="s1388">.</span><span class="s7df">filter</span><span class="s1388">(</span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">it</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40"> </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">it</span><span class="s1f40"> </span><span class="sfa0">!==</span><span class="s1f40"> </span><span class="s7df">source</span><span class="s1388">;</span><span class="s1f40"> </span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// if it is the last stream opened and if the output is not yet closed,
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s1770">// we close it
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s1388">(</span><span class="sfa0">!</span><span class="s7df">sources</span><span class="s1388">.</span><span class="s7df">length</span><span class="s1f40"> </span><span class="sfa0">&amp;&amp;</span><span class="s1f40"> </span><span class="s7df">output</span><span class="s1388">.</span><span class="s7df">readable</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s7df">output</span><span class="s1388">.</span><span class="s7df">end</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">}</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// when a stream is unpiped we remove it
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s7df">output</span><span class="s1388">.</span><span class="s7df">on</span><span class="s1388">(</span><span class="sc1c">&#39;unpipe&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">remove</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// for each stream (arguments is not a regular array this is why we use
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// this syntax)
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s7d0">Array</span><span class="s1388">.</span><span class="s7df">prototype</span><span class="s1388">.</span><span class="s7df">slice</span><span class="s1388">.</span><span class="s7df">call</span><span class="s1388">(</span><span class="s7df">arguments</span><span class="s1388">).</span><span class="s7df">forEach</span><span class="s1388">(</span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">source</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// add the stream to our array of sources
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">sources</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">source</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// bind the remove function to the end event of the source
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">source</span><span class="s1388">.</span><span class="s7df">once</span><span class="s1388">(</span><span class="sc1c">&#39;end&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">remove</span><span class="s1388">.</span><span class="s7df">bind</span><span class="s1388">(</span><span class="s3e8">null</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">source</span><span class="s1388">));</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// pipe the stream to our output, and let it open (the output)
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s1770">// even when the stream ends (in order to handle the others)
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">source</span><span class="s1388">.</span><span class="s7df">pipe</span><span class="s1388">(</span><span class="s7df">output</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s7df">end</span><span class="sfa0">:</span><span class="s1f40"> </span><span class="s3e8">false</span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">output</span><span class="s1388">;</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1388">};</span></code></pre>
</div>
<p>Here again we replace an entire module with few lines of code (~15 SLOC).</p>

<h3 id="vinyl-buffer">vinyl-buffer</h3>

<p>This final module is also part of the vinyl utilitaries. It takes the chunks
from a stream and return them as a nodejs buffer. Like the others, this
one is quite simple and only requires to know a bit of node internal
operations and libraries.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s7df">module</span><span class="s1388">.</span><span class="s7df">exports</span><span class="s1388">.</span><span class="s7df">buffer</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">()</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// like the others we will create a stream object
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">through</span><span class="s1388">.</span><span class="s7df">obj</span><span class="s1388">(</span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">_</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">cb</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">that</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s3e8">this</span><span class="s1388">;</span><span class="s1f40"> </span><span class="s1770">// keep an internal reference of this across js scoping
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">bufs</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s1388">[];</span><span class="s1f40"> </span><span class="s1770">// array of buffer we will populate
</span><span class="s1770"></span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// if it is already a buffer or it contains nothing, just push and finish
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">isNull</span><span class="s1388">()</span><span class="s1f40"> </span><span class="sfa0">||</span><span class="s1f40"> </span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">isBuffer</span><span class="s1388">())</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s7df">that</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">cb</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1388">}</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// otherwise we take the content of the stream and we pipe it
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">contents</span><span class="s1388">.</span><span class="s7df">pipe</span><span class="s1388">(</span><span class="s7df">through</span><span class="s1388">.</span><span class="s7df">obj</span><span class="s1388">(</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">data</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">_</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">cb</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s1770">// create a new buffer with data if it is not and push it to our array
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s7df">bufs</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">Buffer</span><span class="s1388">.</span><span class="s7df">isBuffer</span><span class="s1388">(</span><span class="s7df">data</span><span class="s1388">)</span><span class="s1f40"> </span><span class="sfa0">?</span><span class="s1f40"> </span><span class="s7df">data</span><span class="s1f40"> </span><span class="sfa0">:</span><span class="s1f40"> </span><span class="s3e8">new</span><span class="s1f40"> </span><span class="s7df">Buffer</span><span class="s1388">(</span><span class="s7df">data</span><span class="s1388">));</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s7df">cb</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1388">},</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s3e8">function</span><span class="s1388">()</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s1770">// when we have retrieved all the chunks, create a copy of file
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s7df">file</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">clone</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s1770">// and replace the content with only one huge buffer
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">contents</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">Buffer</span><span class="s1388">.</span><span class="s7df">concat</span><span class="s1388">(</span><span class="s7df">bufs</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s1770">// push it and that&#39;s it
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s7df">that</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s7df">cb</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1388">}</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1388">));</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1388">};</span></code></pre>
</div>
<p>We are still under 20 lines (we start to have a pattern here&hellip; just trolling).
This part is done !</p>

<h3 id="browserify-error-handling-with-gulp">browserify error handling with gulp</h3>

<p>As I mentionned it quickly at the beginning I also want to fix an issue I
have with browserify and gulp.</p>

<p>I finally found the solution on stack overflow and I am surprised that not a
lot of people ran in this problem before.</p>

<p>I also use the <code>gulp.src</code> syntax to retrieve files instead of loading the
globbing module which does exactly the same things
(one dependency removed, Yay \o/).</p>

<p>Here is how I implemented this:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s1f40"></span><span class="s1770">// we need the browserify module
</span><span class="s1770"></span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">browserify</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">require</span><span class="s1388">(</span><span class="sc1c">&#39;browserify&#39;</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1770">// we create a utils.browserify kind of plugin here, which can take options
</span><span class="s1770"></span><span class="s7df">module</span><span class="s1388">.</span><span class="s7df">exports</span><span class="s1388">.</span><span class="s7df">browserify</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">options</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// initialize browserify with options
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">b</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">browserify</span><span class="s1388">(</span><span class="s7df">options</span><span class="s1f40"> </span><span class="sfa0">||</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s7df">debug</span><span class="sfa0">:</span><span class="s1f40"> </span><span class="s3e8">true</span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1770">// here we create a stream which will be pluggable through a pipe
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// in order to avoid spending resources we will use it like this
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// gulp.src(&#39;**/*.js&#39;, {read: false}).pipe(utils.browserify()).pipe(whatever)
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// note the &#34;read: false&#34; which will avoid reading file content and only
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s1770">// provide vinyl file object (not opened) to the stream
</span><span class="s1770"></span><span class="s1f40">  </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">s</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">through</span><span class="s1388">.</span><span class="s7df">obj</span><span class="s1388">(</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// here we only retrieve the files provided by the stream
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">_</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">cb</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s7df">b</span><span class="s1388">.</span><span class="s7df">add</span><span class="s1388">(</span><span class="s7df">file</span><span class="s1388">.</span><span class="s7df">path</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s7df">cb</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1388">},</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770">// and at flush, we bundle the result through browserify
</span><span class="s1770"></span><span class="s1f40">    </span><span class="s3e8">function</span><span class="s1388">()</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s7df">b</span><span class="s1388">.</span><span class="s7df">bundle</span><span class="s1388">()</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1770">// on error we provide a helpful message to the user through gutil.log
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s1388">.</span><span class="s7df">on</span><span class="s1388">(</span><span class="sc1c">&#39;error&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">err</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s3e8">var</span><span class="s1f40"> </span><span class="s7df">message</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7df">err</span><span class="s1388">.</span><span class="s7df">annotated</span><span class="s1f40"> </span><span class="sfa0">||</span><span class="s1f40"> </span><span class="s7df">err</span><span class="s1388">.</span><span class="s7df">toString</span><span class="s1388">();</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s7df">gutil</span><span class="s1388">.</span><span class="s7df">log</span><span class="s1388">(</span><span class="s3e8">new</span><span class="s1f40"> </span><span class="s7df">gutil</span><span class="s1388">.</span><span class="s7df">PluginError</span><span class="s1388">(</span><span class="sc1c">&#39;browserify&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7df">message</span><span class="s1388">).</span><span class="s7df">toString</span><span class="s1388">());</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s1770">// and here is the magic not provided before, we notice gulp that
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s1770">// the stream as ended, and it can continue to watch our files states
</span><span class="s1770"></span><span class="s1f40">        </span><span class="s7df">s</span><span class="s1388">.</span><span class="s7df">emit</span><span class="s1388">(</span><span class="sc1c">&#39;end&#39;</span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1388">})</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1770">// when data is provided by the stream we simply push it into the
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s1770">// returned one
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s1388">.</span><span class="s7df">on</span><span class="s1388">(</span><span class="sc1c">&#39;data&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">(</span><span class="s7df">chunk</span><span class="s1388">)</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40"> </span><span class="s7df">s</span><span class="s1388">.</span><span class="s7df">push</span><span class="s1388">(</span><span class="s7df">chunk</span><span class="s1388">);</span><span class="s1f40"> </span><span class="s1388">})</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">      </span><span class="s1770">// do not forget to pass the end event also
</span><span class="s1770"></span><span class="s1f40">      </span><span class="s1388">.</span><span class="s7df">on</span><span class="s1388">(</span><span class="sc1c">&#39;end&#39;</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s3e8">function</span><span class="s1388">()</span><span class="s1f40"> </span><span class="s1388">{</span><span class="s1f40"> </span><span class="s7df">s</span><span class="s1388">.</span><span class="s7df">emit</span><span class="s1388">(</span><span class="sc1c">&#39;end&#39;</span><span class="s1388">);</span><span class="s1f40"> </span><span class="s1388">});</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1388">}</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s1388">);</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">  </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7df">s</span><span class="s1388">;</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1388">};</span></code></pre>
</div>
<p>This one was quite more complicated but it finally works and I am happy to stay
in the &ldquo;gulp world&rdquo; and do not provide any tricky thing.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This experience was really interesting, reducing code dependencies,
gaining power on underlying nodejs concepts, fixing some bugs also.
This was not a waste of time and I really enjoyed it.</p>

<p>I also will not make any comment on node ecosystem because I think everything
has already been told. But this exercise proved that some libraries are really
not complicated and can be reimplemented in order to avoid bad surprise in the
future.</p>

  </div>
</article>
<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "IxDay" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
    

    <footer id="footer">
	<p>&copy; 2018 IxDay</p>
	<p>Done with love... and beer</p>
  <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>,</p>
</footer>

    </div>
  </body>
</html>
