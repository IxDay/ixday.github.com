<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.75.1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel='stylesheet' id='oswald-css'  href='//fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all'>
  <link rel="stylesheet" href="https://ixday.github.io/css/style.css" type='text/css' media='all'>
  <link rel="stylesheet" href="https://ixday.github.io/css/pygment.css" type='text/css' media='all'>
  
  <title>Not today... - Libvirt through vagrant</title>
  <meta property='og:title' content="Libvirt through vagrant - Not today...">
  <meta property="og:type" content="article">
  

</head>

  <body>
    <div class="container">
    <header>
  <h1 id="site-title"><a href="https://ixday.github.io/">Not today...</a></h1>
  <nav id="menu">
    <ul>
      
        
          <li><a href="https://github.com/IxDay">github</a></li>
        
      
      
      
      <li><a href="/categories/os">os</a></li>
      
      <li><a href="/categories/project">project</a></li>
      
      <li><a href="/categories/snippet">snippet</a></li>
      
      <li><a href="/categories/tuto">tuto</a></li>
      
      
    </ul>
  </nav>
</header>

    
    <div class="contents">
      
<article>
  <div class="meta">
  <time class="date">
    
    Fri Jun 3 2016
    
  </time>
  <div class="comments">
    <a href="https://ixday.github.io/post/libvirt_through_vagrant/#disqus_thread">
      <span class="disqus-comment-count" data-disqus-identifier="IxDay">
      </span>
      comments
    </a>
  </div>
  <p class="categories">
  
  <a href="/categories/tuto">Tuto</a>
  
  </p>
</div>

  <div class="caption">
    <header>
      <h2>Libvirt through vagrant</h2>

      
      <p class="tags">
      <strong>Tagged</strong>
      <a href="/tags/admin ">admin</a>

      </p>
      

    </header>
    <p>I will not install VirtualBox! That&rsquo;s all (nor VMWare, don&rsquo;t be ridiculous).
But I really like <a href="https://www.vagrantup.com/">Vagrant</a>, and use it every time
I need something closer to a running machine. So, I dig up the internet and
found that there is an unofficial support of libvirt.</p>
<h2 id="installation">Installation</h2>
<p>I do not remember where I found the documentation to do this or if I did it by
myself, so no link here, just what I do in order to make this work. I use a
debian jessie distribution, so packages name may vary.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Install packages</span>
apt-get install qemu-kvm libvirt-daemon-system libvirt-dev zlib1g-dev vagrant

<span class="c1"># Install vagrant plugin</span>
vagrant plugin install vagrant-libvirt

<span class="c1"># Add user to group</span>
gpasswd -a user_name libvirt

<span class="c1"># Reboot in order to load kvm and group change</span>
reboot
</code></pre></div><p>Now everything is installed and ready to work with the libvirt provider.
In order to verify that everything works, run:
<code>vagrant init debian/jessie64; vagrant up --provider libvirt</code>.
It must download a debian/jessie image then run it through vagrant.</p>
<h2 id="in-action">In action</h2>
<p>For this example, I will just run a Coreos image, and show you how you can
migrate an existing Vagrantfile to the libvirt provider.</p>
<p>Clone this repo <a href="https://github.com/coreos/coreos-vagrant,">https://github.com/coreos/coreos-vagrant,</a> and follow the
instructions.</p>
<p>Then according to this PR, I made a modification to the Vagrantfile
<a href="https://github.com/coreos/coreos-vagrant/pull/290/files,">https://github.com/coreos/coreos-vagrant/pull/290/files,</a> I also added
a valid <code>box_url</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">
  <span class="c1"># if the provider asked is libvirt</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>

    <span class="c1"># change the box to a libvirt compatible one</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&#34;dongsupark/coreos-%s&#34;</span> <span class="o">%</span> <span class="vg">$update_channel</span>

    <span class="c1"># this line indicates where the box can be found</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&#34;https://atlas.hashicorp.com/dongsupark/boxes/coreos-%s&#34;</span> <span class="o">%</span> <span class="vg">$update_channel</span>

    <span class="c1"># change the driver name and pass the parameters needed to comply with</span>
    <span class="c1"># specifications</span>
    <span class="n">v</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="s2">&#34;kvm&#34;</span>
    <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="vg">$vm_memory</span>
    <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="vg">$vm_cpus</span>

  <span class="k">end</span>
</code></pre></div><p>Now you can do a <code>vagrant up</code> and it will work (it works on my machine :p).</p>
<h2 id="bonus">Bonus</h2>
<p>You can migrate Vagrant images to libvirt with another plugin:
<code>vagrant-mutate</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Install the plugin</span>
vagrant plugin install vagrant-mutate

<span class="c1"># Mutate an image</span>
vagrant mutate https://atlas.hashicorp.com/debian/boxes/jessie64/versions/8.2.2/providers/virtualbox.box libvirt

<span class="c1"># Now the image is available, you can rename it if needed</span>
mv ~/.vagrant.d/boxes/virtualbox ~/.vagrant.d/boxes/debian-VAGRANTSLASH-jessie64

<span class="c1"># Then run it</span>
vagrant init debian/jessie64<span class="p">;</span> vagrant up --provider libvirt
</code></pre></div><p>This is no longer really needed as there is more and more images with libvirt
provider.</p>

  </div>
</article>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "IxDay" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
    

    <footer id="footer">
	<p>&copy; 2020 IxDay</p>
	<p>Done with love... and beer</p>
  <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>,</p>
</footer>

    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-38228870-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>
